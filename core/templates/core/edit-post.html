{% extends 'base.html' %}

{% block extera_header %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <script src="https://cdn.ckeditor.com/4.16.2/standard/ckeditor.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
{% endblock %}

{% block extera_style %}
  <style>
    body, h1, h2, h3, h4, h5 {
      font-family: "Raleway", sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
    }
    .content-wrapper {
      display: inline;
    }
    .w3-content {
      max-width: 1400px;
      margin: auto;
    }
    footer {
      background-color: #333;
      color: white;
      padding: 20px;
      text-align: center;
    }
    #crop-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }
    #crop-container {
      background: white;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
  </style>
{% endblock %}

{% block content %}
<div class="w3-light-grey">
  <div class="w3-content w3-padding-32">
    <h2>Create a New Blog Post</h2>
    <form class="w3-container w3-card-4 w3-white w3-padding-16" method="post" enctype="multipart/form-data" action="">
      {% csrf_token %}
      <label for="id_title_heading" class="w3-text-grey"><b>Title Heading</b></label>
      <input id="id_title_heading" name="title_heading" class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Enter title heading...">

      <label for="id_slug" class="w3-text-grey"><b>Slug</b></label>
      <input id="id_slug" name="slug" class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Enter post slug...">

      <label for="id_title_description" class="w3-text-grey"><b>Title Description</b></label>
      <input id="id_title_description" name="title_description" class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Enter title description...">

      <label for="id_description" class="w3-text-grey"><b>Description</b></label>
      <textarea id="id_description" name="description" class="w3-input w3-border w3-margin-bottom" rows="6" placeholder="Enter post description..."></textarea>

      <label for="id_cover_image" class="w3-text-grey"><b>Cover Image</b></label>
      <input id="id_cover_image" name="cover_image" class="w3-input w3-border w3-margin-bottom" type="file" accept="image/*">

      <!-- Modal for Cropping -->
      <div id="crop-modal">
        <div id="crop-container">
          <img id="image-to-crop" src="" alt="To Crop" style="max-width: 100%;">
          <br>
          <button id="crop-button" class="w3-button w3-black w3-margin-top">Crop and Upload</button>
        </div>
      </div>

      <!-- Hidden input for cropped image -->
      <input type="file" id="cropped-image-input" name="cropped_image" style="display: none;">

      <label for="id_tags" class="w3-text-grey"><b>Tags</b></label>
      <select id="id_tags" name="tags" class="w3-select w3-border" multiple>
        {% for tag in tags %}
          <option value="{{ tag.id }}">{{ tag.name }}</option>
        {% endfor %}
      </select>
      <p class="w3-text-grey" style="font-size: 0.9em; margin-top: 5px;">* Hold the "Ctrl key" and "click" to select multiple tags.</p>

      <button type="submit" class="w3-button w3-black w3-padding-large w3-margin-top">Save Post</button>
    </form>
  </div>
</div>
{% endblock %}

{% block js %}

  CKEDITOR.replace('id_description', {
    toolbar: 'full',
    height: 300,
    extraPlugins: 'uploadimage',
  });

  document.getElementById('id_cover_image').addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const image = document.getElementById('image-to-crop');
        image.src = e.target.result;
        document.getElementById('crop-modal').style.display = 'flex';

        const cropper = new Cropper(image, {
          aspectRatio: 7 / 2,
          viewMode: 1,
        });

        document.getElementById('crop-button').onclick = function (e) {
          e.preventDefault();
          const canvas = cropper.getCroppedCanvas();
          canvas.toBlob(function (blob) {
            // Create a new File object from the cropped image
            const croppedFile = new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' });

            // Create a new FileList and assign the cropped file to it
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);

            // Assign the FileList to the hidden input
            const croppedImageInput = document.getElementById('cropped-image-input');
            croppedImageInput.files = dataTransfer.files;

            // Hide the modal and destroy the cropper instance
            document.getElementById('crop-modal').style.display = 'none';
            cropper.destroy();
          }, 'image/jpeg');
        };
      };
      reader.readAsDataURL(file);
    }
  });

  const titleInput = document.getElementById('id_title_heading');
  const slugInput = document.getElementById('id_slug');

  titleInput.addEventListener('input', () => {
    slugInput.value = titleInput.value.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
  });
{% endblock %}